stages:
  - test
  - build
  - publish

variables:
  NODE_VERSION: "22"

default:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm install --frozen-lockfile

# Cache node_modules across jobs
cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - node_modules/
    - .pnpm-store/

test:unit:
  stage: test
  script:
    - pnpm test:unit
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'

test:integration:
  stage: test
  script:
    - pnpm test:integration

typecheck:
  stage: test
  script:
    - pnpm typecheck

build:
  stage: build
  script:
    - pnpm build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

publish:
  stage: publish
  script:
    - echo "@gogo-meta:registry=https://${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/" > .npmrc
    - echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
    - npm publish
  rules:
    - if: $CI_COMMIT_TAG
      when: always
    - when: never
  dependencies:
    - build
