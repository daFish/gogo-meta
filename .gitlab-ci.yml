stages:
  - test
  - build
  - publish

variables:
  NODE_VERSION: "22"

default:
  image: oven/bun:latest
  before_script:
    - bun install --frozen-lockfile

# Cache node_modules across jobs
cache:
  key:
    files:
      - bun.lockb
  paths:
    - node_modules/

test:unit:
  stage: test
  script:
    - bun run test:unit
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'

test:integration:
  stage: test
  script:
    - bun run test:integration

typecheck:
  stage: test
  script:
    - bun run typecheck

build:
  stage: build
  script:
    - bun run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

publish:
  stage: publish
  script:
    - echo "@gogo-meta:registry=https://${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/" > .npmrc
    - echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
    - npm publish
  rules:
    - if: $CI_COMMIT_TAG
      when: always
    - when: never
  dependencies:
    - build
